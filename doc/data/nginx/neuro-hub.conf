# -----------------------------------------------------------
# 1. HTTP сервер для app.neuro-hub.pro (перенаправление на HTTPS)
# -----------------------------------------------------------
server {
    listen 80;
    listen [::]:80;
    server_name app.neuro-hub.pro;
    location ^~ /.well-known/acme-challenge/ {
    	root /var/www/certbot;
    	allow all;
    	default_type "text/plain";
    	try_files $uri =404;
	} 

    # Перенаправление всех запросов на HTTPS
    location / {
	return 301 https://$host$request_uri;
    }
}

# -----------------------------------------------------------
# 2. HTTPS сервер для Open-WebUI (app.neuro-hub.pro)
# -----------------------------------------------------------
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name app.neuro-hub.pro;

    client_max_body_size 100M;

    ssl_certificate /etc/letsencrypt/live/login.entire.vc/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/login.entire.vc/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;

    # GTM - Встраиваем код Google Tag Manager
#    sub_filter '<head>' '<head>
#	<script>
#        (function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({"gtm.start":
#        new Date().getTime(),event:"gtm.js"});var f=d.getElementsByTagName(s)[0],
#        j=d.createElement(s),dl=l!="dataLayer"?"&l="+l:"";j.async=true;j.src=
#        "https://www.googletagmanager.com/gtm.js?id="+i+dl;f.parentNode.insertBefore(j,f);
#        })(window,document,"script","dataLayer","GTM-NL2V7LBL");
#    </script>
#	<script src="https://telegram.org/js/telegram-web-app.js"></script>
#	<script>
#(async function () {
#  const wa = window.Telegram && window.Telegram.WebApp;
#  const isTMA = !!(wa && wa.initData && wa.initData.length > 0 &&
#                   wa.initDataUnsafe && wa.initDataUnsafe.user && wa.initDataUnsafe.user.id);
#
#  await fetch("https://venturecrew.app.n8n.cloud/webhook/webhook/tma-test2", {
#    method: "POST",
#    headers: { "content-type": "application/json" },
#    body: JSON.stringify({
#      t: "test2_ping",
#      initData: wa.initData,  
#      query_id: wa.initDataUnsafe?.query_id || null,
#      user_id: wa.initDataUnsafe?.user?.id || null,
#      bot_token: "123"
#    })
#  });
#})();
#</script>';

   sub_filter '<head>' '<head>$inject_owui';
 
    sub_filter_once off;

    location ~ "^/update/webapp/([0-9A-F]{8}-[0-9A-F]{4}-[0-9A-F]{4}-[0-9A-F]{4}-[0-9A-F]{12})/([0-9]{1,2}\.[0-9]{1,2}\.[0-9]{1,2}\.[0-9]{1,2})/(check|download)/$" {
        alias /var/www/app.neuro-hub.pro/update/;
        index index.php;
        try_files $uri $uri/ @update;
    }

    location @update {
        root /var/www/app.neuro-hub.pro/update/;
        index index.php;

        fastcgi_pass unix:/run/php/php8.2-fpm.sock;
        fastcgi_param  SCRIPT_FILENAME /var/www/app.neuro-hub.pro/update/index.php;
        fastcgi_param  QUERY_STRING     $query_string;
        fastcgi_param  UPDATE_GUID $1;
        fastcgi_param  UPDATE_VERSION $2;
        fastcgi_param  UPDATE_CHECK $3;
        fastcgi_buffers 16 16k;
        fastcgi_buffer_size 32k;
        fastcgi_intercept_errors on;
        include fastcgi_params;
    }

    location ~ "^/update/([0-9A-F]{8}-[0-9A-F]{4}-[0-9A-F]{4}-[0-9A-F]{4}-[0-9A-F]{12})/update.msi" {
        internal;
        add_header Content-Type application/octet-stream;
        add_header Content-Disposition 'attachment; filename="update.msi"';
        root /var/www/app.neuro-hub.pro;
    }

    location /api/internal/events {
        # Логи для мониторинга
        access_log /var/log/nginx/internal_events.log;
        error_log /var/log/nginx/internal_events_error.log;
        
        # Разрешаем только POST и OPTIONS
        if ($request_method !~ ^(POST|OPTIONS)$) {
            return 405;
        }
        
        # CORS preflight
        if ($request_method = 'OPTIONS') {
            add_header 'Access-Control-Allow-Origin' '*';
            add_header 'Access-Control-Allow-Methods' 'POST, OPTIONS';
            add_header 'Access-Control-Allow-Headers' 'Content-Type';
            add_header 'Content-Length' 0;
            return 204;
        }
        
        # Proxy на N8N webhook
        proxy_pass https://venturecrew.app.n8n.cloud/webhook/c8860224-257d-47ae-8d6b-40130308c2da;
        proxy_ssl_server_name on;
        proxy_set_header Host venturecrew.app.n8n.cloud;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # CORS для ответа
        add_header 'Access-Control-Allow-Origin' '*' always;
        
        # Таймауты
        proxy_connect_timeout 5s;
        proxy_send_timeout 5s;
        proxy_read_timeout 5s;
    }
    

    location / {
        proxy_pass http://127.0.0.1:3000;
        proxy_http_version 			1.1;
        proxy_set_header Upgrade 		$http_upgrade;
        proxy_set_header Connection 		"upgrade";
        proxy_set_header Host 			$host;
	proxy_set_header X-Real-IP 		$remote_addr;
	proxy_set_header Accept-Encoding 	"";
	proxy_set_header X-Forwarded-Scheme 	$scheme;
	proxy_set_header X-Forwarded-Proto 	$scheme;
	proxy_set_header X-Forwarded-For 	$proxy_add_x_forwarded_for;
        chunked_transfer_encoding 	off;
	proxy_buffering 		off;
	proxy_cache 			off;
 	keepalive_timeout 		3600;
	proxy_connect_timeout 		3600;
	proxy_read_timeout 		3600;
	proxy_send_timeout 		3600;
    }
# Отдаём файлы из локальной папки для /static/
    location /static/ {
        root /var/www/app.neuro-hub.pro/static/;                     # Укажите путь к папке на хосте
        autoindex off;
    }

    location /favicon/ {
        root /var/www/app.neuro-hub.pro/static/;                     # Укажите путь к папке на хосте
        autoindex off;
    }
}
#    location = /monitor {
#        return 301 /monitor/;
#    }
#    location /monitor/ {
#        # Отключаем GTM-sub_filter, чтобы не портить HTML монитора
#        sub_filter '</head>' '</head>';
#	sub_filter_once off;
#
#        # !!! Важен завершающий слэш — тогда префикс /monitor/ удалится !!!
#        proxy_pass        http://127.0.0.1:7878;
#
#        proxy_http_version 1.1;
#        proxy_set_header Upgrade $http_upgrade;
#        proxy_set_header Connection "upgrade";
#
#        proxy_set_header Host              $host;
#        proxy_set_header X-Real-IP         $remote_addr;
#        proxy_set_header X-Forwarded-Proto $scheme;
#        proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
#
#        proxy_buffering  off;
#        proxy_connect_timeout 3600;
#        proxy_read_timeout    3600;
#        proxy_send_timeout    3600;
#    }
#	location ^~ /monitor/_next/ {
#        	proxy_pass http://127.0.0.1:7878;
#        	proxy_set_header Host $host;
#        	proxy_cache_valid 200 30m;
#    }
#}
# -----------------------------------------------------------
# 3. HTTP сервер для Paymenter (перенаправление с pay.neuro-hub.pro на HTTPS)
# -----------------------------------------------------------
#server {
#    listen 80;
#    listen [::]:80;
#    server_name pay.neuro-hub.pro;
#    
#    # Перенаправление на HTTPS
#    return 301 https://$host$request_uri;
#}

# -----------------------------------------------------------
# 4. HTTPS сервер для Paymenter (pay.app.neuro-hub.pro)
# -----------------------------------------------------------
#server {
#    listen 443 ssl;
#    listen [::]:443 ssl;
#    server_name pay.neuro-hub.pro;
#
#    root /var/www/paymenter/public;
#
#    index index.php;
#
#    ssl_certificate /etc/letsencrypt/live/pay.neuro-hub.pro/fullchain.pem;
#    ssl_certificate_key /etc/letsencrypt/live/pay.neuro-hub.pro/privkey.pem;
#    include /etc/letsencrypt/options-ssl-nginx.conf;
#    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;
#
#    location / {
#        try_files $uri $uri/ /index.php?$query_string;
#    }
#
#    location ~ \.php$ {
#        include snippets/fastcgi-php.conf;
#        fastcgi_pass unix:/var/run/php/php8.2-fpm.sock;
#    }
#}
