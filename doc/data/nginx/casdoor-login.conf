# ======================================================================
# 1. HTTP  →  HTTPS  (login.*)
# ======================================================================
server {
    listen 80;
    listen [::]:80;
    server_name
	login.venture-crew.com
        login.neuro-hub.pro
	login.entire.vc
	login.prototypes.ventures;

    
    location ^~ /.well-known/acme-challenge/ {
   	root /var/www/certbot;
    	allow all;
    	default_type "text/plain";
    	try_files $uri =404;
    }
	
	
    location / {
        return 301 https://$host$request_uri;
    }

}

# ======================================================================
# 2. HTTPS  (Casdoor)
# ======================================================================
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name
        login.entire.vc
        login.venture-crew.com
        login.neuro-hub.pro
	login.prototypes.ventures;
#	login.jfdi.expert


    client_max_body_size 50M;

    ssl_certificate     /etc/letsencrypt/live/login.entire.vc/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/login.entire.vc/privkey.pem;
    include             /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam         /etc/letsencrypt/ssl-dhparams.pem;
    # ssl_protocols TLSv1.2 TLSv1.3;
    # ssl_ciphers HIGH:!aNULL:!MD5;
   if ($host = login.entire.vc) {
        rewrite ^/(login)?/?$ https://login.entire.vc/login/entire_vc permanent;
    }
    if ($host = login.neuro-hub.pro) {
        rewrite ^/(login)?/?$ https://login.neuro-hub.pro/login/neurohub_pro permanent;
    }
#    if ($host = login.prototypes.ventures) {
#	rewrite ^/(login)?/?$ https://login.prototypes.ventures/login/prototypes_ventures permanent;
#    }

    # --- Yandex-проверка ------------------------------------------------
    location = /yandex_6349ad1b9e208b32.html {
        if ($host != "login.neuro-hub.pro") { return 404; }
        default_type text/html;
        return 200 '<html><body>Verification: 6349ad1b9e208b32</body></html>';
    }

    # ------------------------------------------------------------------
    #  Основной прокси к Casdoor (работает на 127.0.0.1:8000)
    # ------------------------------------------------------------------
    location / {
        proxy_pass         http://127.0.0.1:8000;
        proxy_http_version 1.1;
	#####
#	proxy_set_header Accept-Language "ru-RU,ru;q=0.9,en;q=0.8";
	proxy_set_header Accept-Language "en";
	#####
        proxy_set_header   Upgrade           $http_upgrade;
        proxy_set_header   Connection        $connection_upgrade;
        proxy_set_header   Host              $host;
        proxy_set_header   X-Real-IP         $remote_addr;
        proxy_set_header   X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header   X-Forwarded-Proto $scheme;

        proxy_connect_timeout 300s;
        proxy_send_timeout    300s;
        proxy_read_timeout    300s;
        send_timeout          300s;

        client_body_buffer_size 10M;
        proxy_buffer_size       128k;
        proxy_buffers           4 256k;
        proxy_busy_buffers_size 256k;
    
	######################
	# ---------- Вклейка счётчика ----------
    	# 1) Чтобы sub_filter видел «сырой» текст, запрещаем gzip от upstream
    	proxy_set_header   Accept-Encoding   "";
    	# 2) Указываем mime‑тип, к которому будет применяться фильтр
    	sub_filter_types   text/html;
    	# 3) Скрипт счётчика. Обязательно экранируйте символы кавычекi!

	sub_filter '<head>' '<head>$inject_head';

#	sub_filter '</head>' '
#		<link rel="icon" type="image/png" href="/files/avatar/entire_vc/nh-512-1-300x300.png" sizes="any">
#		<link rel="stylesheet" href="https://login.neuro-hub.pro/files/files/inject.css">
#		<script defer src="https://login.neuro-hub.pro/files/files/inject.js"></script>
#	</head>';

    	# 4) Выполнять замену не один раз, а в каждом кусочке (на всякий случай)
    	sub_filter_once off;

	########################
	}

    	# ------------------------------------------------------------------
    	#  CORS для /files/
    	# ------------------------------------------------------------------
    	location /files/ {
        	# Pre-flight
        	if ($request_method = OPTIONS) {
        		add_header Access-Control-Allow-Origin  $scheme://$host always;
            		# add_header Access-Control-Allow-Origin "https://login.neuro-hub.pro" always;
            		add_header Access-Control-Allow-Methods "GET, HEAD, OPTIONS" always;
            		add_header Access-Control-Allow-Headers "*" always;
            		add_header Content-Length 0;
            		return 204;
        	}

        	add_header Access-Control-Allow-Origin  $scheme://$host always;
        	# add_header Access-Control-Allow-Origin "https://login.neuro-hub.pro" always;
        	add_header Access-Control-Allow-Methods "GET, HEAD, OPTIONS" always;
        	add_header Access-Control-Allow-Headers "*" always;

        	proxy_pass         http://127.0.0.1:8000;
        	proxy_set_header   Host              $host;
        	proxy_set_header   X-Real-IP         $remote_addr;
        	proxy_set_header   X-Forwarded-For   $proxy_add_x_forwarded_for;
        	proxy_set_header   X-Forwarded-Proto $scheme;
    	

	}

	# ===== VK ID Bridge (проксируем на локальный сервис) =====
	location ^~ /vkid/ {
    	proxy_pass         http://127.0.0.1:18080;
    	proxy_http_version 1.1;

    	proxy_set_header   Host              $host;
    	proxy_set_header   X-Real-IP         $remote_addr;
    	proxy_set_header   X-Forwarded-For   $proxy_add_x_forwarded_for;
    	proxy_set_header   X-Forwarded-Proto $scheme;

    	# Тонкие таймауты — на обмен токенов (можно ужесточить)
    	proxy_connect_timeout 30s;
    	proxy_send_timeout    30s;
    	proxy_read_timeout    30s;
    	send_timeout          30s;
	}


}

